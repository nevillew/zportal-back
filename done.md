## 2025-04-15

-   **Tasks Function:** Implemented basic conditional task logic evaluation in the PUT handler. Before allowing a status update to 'Complete', it checks if the task's `condition` field specifies a `required_dependency_status` and verifies that the dependency task has the required status. (`supabase/functions/tasks/index.ts`)
-   **Tasks Function:** Added circular dependency check using a new PostgreSQL helper function (`check_task_circular_dependency`) called via RPC during task updates (PUT). Prevents setting a `depends_on_task_id` that would create a loop. (Migration: `20250415100000_add_circular_dependency_check.sql`, Function: `supabase/functions/tasks/index.ts`)
-   **Task Files Function:** Implemented specific error handling for database constraints (FK violation, NOT NULL) and Storage API errors during file upload (POST) and deletion (DELETE). (`supabase/functions/task-files/index.ts`)
-   **Task Comments Function:** Added permission check to allow staff users to delete any task comment, in addition to the original author. (`supabase/functions/task-comments/index.ts`)
-   **Tasks Function:** Refined permission check in PUT handler to allow assigned users to update tasks flagged as `is_self_service`, aligning function logic with RLS policy. (`supabase/functions/tasks/index.ts`)
-   **Instantiate Project Template Function:** Added graceful error handling using a main try-catch block and more specific error messages for failures during template fetching, placeholder resolution, or database insertions. (`supabase/functions/instantiate-project-template/index.ts`)
-   **Storage Policies:** Refined `task-attachments` storage bucket policies (SELECT, INSERT, DELETE) to use RLS helper functions (`can_access_project`, `is_staff_user`, `has_permission`) for consistency. (`scripts/setup-storage-policies.js`)
-   **Notification Sender Function:** Created new Edge Function (`send-notification`) to handle sending notifications via Email (Resend) and Slack. Includes input validation, secret fetching (placeholder for Vault), API call logic using `fetch`, and basic internal authentication check. (`supabase/functions/send-notification/index.ts`)
-   **Accept Invite Function:** Created new Edge Function (`accept-invite`) to handle user invitation acceptance. Validates token, status, expiry, and user email. Creates `company_users` record and updates invitation status. (`supabase/functions/accept-invite/index.ts`)
-   **SSO JIT Provisioning Handler:** Created new Edge Function (`sso-jit-provisioning`) triggered by Supabase Auth Hook. Parses claims, finds company SSO config via domain, maps attributes (name, role) based on config, upserts user profile and company user association, returns custom claims for JWT. (`supabase/functions/sso-jit-provisioning/index.ts`)
-   **Global Search RPC:** Created PostgreSQL function `global_search(p_user_id, p_query, p_filters, p_page, p_page_size)` to query the `search_index` table using FTS, apply filters, enforce RLS based on the calling user, and return paginated results with relevance ranking. (Migration: `20250415110000_add_global_search_rpc.sql`)
-   **Reporting RPC (Project Summary):** Created PostgreSQL function `get_project_summary(p_user_id, p_filters, p_page, p_page_size)` to query the `view_project_summary` view, apply filters (company, status, stage, health), enforce RLS, and return paginated results. (Migration: `20250415120000_add_rpc_get_project_summary.sql`)
-   **Reporting RPC (Task Details):** Created PostgreSQL function `get_task_details(p_user_id, p_filters, p_page, p_page_size)` to query the `view_task_details` view, apply filters (company, project, status, priority, assignee), enforce RLS, and return paginated results. (Migration: `20250415130000_add_rpc_get_task_details.sql`)
-   **Reporting RPC (Overdue Tasks):** Created PostgreSQL function `get_overdue_tasks(p_user_id, p_filters, p_page, p_page_size)` to query the `view_overdue_tasks` view, apply filters (company, project, assignee), enforce RLS, and return paginated results. (Migration: `20250415140000_add_rpc_get_overdue_tasks.sql`)
-   **Reporting RPC (Staff Workload):** Created PostgreSQL function `get_staff_workload(p_user_id, p_filters, p_page, p_page_size)` to query the `view_staff_workload` view, apply filters, enforce RLS (staff only), and return paginated results. (Migration: `20250415150000_add_rpc_get_staff_workload.sql`)
-   **Reporting RPC (Time Tracking Summary):** Created PostgreSQL function `get_time_tracking_summary(p_user_id, p_filters, p_page, p_page_size)` to query the `view_time_tracking_summary` view, apply filters, enforce RLS, and return paginated results. (Migration: `20250415160000_add_rpc_get_time_tracking_summary.sql`)
-   **Reporting RPC (Effort Variance):** Created PostgreSQL function `get_effort_variance(p_user_id, p_filters, p_page, p_page_size)` to query the `view_effort_variance` view, apply filters, enforce RLS, and return paginated results. (Migration: `20250415170000_add_rpc_get_effort_variance.sql`)
-   **Reporting RPC (Milestone Status):** Created PostgreSQL function `get_milestone_status(p_user_id, p_filters, p_page, p_page_size)` to query the `view_milestone_status` view, apply filters, enforce RLS, and return paginated results. (Migration: `20250415180000_add_rpc_get_milestone_status.sql`)
-   **Reporting Views & RPCs (Batch):** Created SQL views and corresponding RPC functions for remaining reports: `view_company_training_compliance`, `view_open_risks_issues`, `view_template_performance`, `view_client_engagement_summary`, `view_onboarding_cycle_time`, `view_document_usage`, `view_custom_field_analysis`. RPCs include filtering, pagination, and RLS checks. (Migrations: `20250415200100` to `20250415201400`)
-   **Time Tracking:** Created `time_entries` and `active_timers` tables with RLS policies. Implemented RPC functions `start_task_timer`, `stop_task_timer`, and `log_manual_time` for managing time tracking. (Migrations: `20250415210100` to `20250415210400`)
-   **Announcements:** Created `announcements` table with RLS policies. Implemented Edge Function (`announcements`) for CRUD operations, restricting modifications to staff users. (Migration: `20250415220100_create_announcements_table.sql`, Function: `supabase/functions/announcements/index.ts`)
-   **Mentions:** Created PostgreSQL trigger function `process_mentions_and_notify` to parse `@mentions` in `task_comments`, resolve users by full name, and call the `send-notification` function via `pg_net`. Applied trigger to `task_comments`. (Migration: `20250415230100_add_mention_trigger.sql`)
-   **Documents API:** Created Edge Function (`documents`) for basic CRUD operations on the `documents` table, including permission checks based on scope and user roles/permissions. (Function: `supabase/functions/documents/index.ts`)
-   **Pages API:** Created `pages` table with RLS policies inheriting access from parent document. Implemented Edge Function (`pages`) for CRUD operations, checking parent document permissions. (Migration: `20250416000100_create_pages_table.sql`, Function: `supabase/functions/pages/index.ts`)
-   **Feedback API:** Created `feedback` table with RLS policies. Implemented Edge Function (`feedback`) for submitting feedback (POST), associating it with the logged-in user. (Migration: `20250416010100_create_feedback_table.sql`, Function: `supabase/functions/feedback/index.ts`)
-   **Welcome Sequence:** Created PostgreSQL trigger function `send_welcome_notification` to call the `send-notification` function via `pg_net` when a user is added to `company_users`. (Migration: `20250416020100_add_welcome_notification_trigger.sql`)
-   **Messaging API:** Created `conversations`, `conversation_participants`, and `messages` tables with RLS policies. Implemented Edge Function (`messaging`) for listing/creating conversations and listing/sending messages. (Migration: `20250416030100_create_messaging_tables.sql`, Function: `supabase/functions/messaging/index.ts`)
-   **Calendly Webhook Handler:** Created Edge Function (`calendly-webhook-handler`) to process `invitee.created` and `invitee.canceled` events. Parses payload, extracts context (project/company ID via custom questions - placeholder), upserts/updates `meetings` table. Includes placeholder for signature verification. (Function: `supabase/functions/calendly-webhook-handler/index.ts`)
-   **Certificate Generation:** Created `course_certificates` table. Implemented Edge Function (`generate-certificate`) to call PDFMonkey, upload PDF to storage, and create DB record. Added DB trigger function (`trigger_certificate_generation`) on `lesson_completions` to check for course completion and invoke the Edge Function via `pg_net`. (Migrations: `20250416040100`, `20250416040200`. Function: `supabase/functions/generate-certificate/index.ts`)
-   **Gamification Trigger:** Created PostgreSQL trigger function `award_badges_on_lesson_completion` to check `badges` criteria and award badges by inserting into `user_badges` upon lesson completion. Applied trigger to `lesson_completions`. (Migration: `20250416050100_add_gamification_trigger.sql`)
-   **Issue Notifications:** Created PostgreSQL trigger function `notify_issue_change` to call the `send-notification` function via `pg_net` when an issue's assignment or status changes. Applied trigger to `issues`. (Migration: `20250416060100_add_issue_notification_trigger.sql`)
-   **Milestone Notifications:** Added logic to the `milestones` Edge Function (POST `/milestones/{id}/approve`) to call the `send-notification` function upon successful milestone approval, notifying the project owner. (`supabase/functions/milestones/index.ts`)
-   **Risk Notifications:** Created PostgreSQL trigger function `notify_risk_change` to call the `send-notification` function via `pg_net` when a risk's assignment or status changes. Applied trigger to `risks`. (Migration: `20250416070100_add_risk_notification_trigger.sql`)
-   **Instantiate Template Refactor:** Moved core project instantiation logic from Edge Function to a transactional PostgreSQL RPC function (`instantiate_template_rpc`). Updated Edge Function to call the RPC. (Migration: `20250416080100_add_instantiate_template_rpc.sql`, Function: `supabase/functions/instantiate-project-template/index.ts`)

## 2025-04-14

-   **Risks Function:** Enhanced `supabase/functions/risks/index.ts`:
    -   Added validation for `status`, `probability`, and `impact` fields against allowed enum values in POST/PUT requests.
    -   Implemented specific error handling for database constraints (foreign key, check, not null) and missing records (PGRST204) during POST, PUT, and DELETE operations, returning appropriate 4xx HTTP status codes.
    -   Verified existing permission checks using `has_permission` and staff status.
-   **Seed Data:** Create `supabase/seed.sql` file and populate it with default system roles ('Staff Admin', 'Project Manager', 'Implementation Specialist', 'Company Admin', 'Client Viewer') and their corresponding `base_permissions` JSONB definitions based on `plan.md`. Marked roles as `is_system_role = true`.

## 2025-04-13

-   **RLS:** Define and apply RLS policies for `meetings` table (SELECT, INSERT, UPDATE, DELETE) using helper functions and respecting status lock logic. (Migration: `20250413120000_add_rls_meetings.sql`)
-   **RLS:** Define and apply RLS policies for training tables (`courses`, `lessons`, `course_assignments`, `lesson_completions`) covering user access, staff management, and assignment/completion logic. (Migration: `20250413130000_add_rls_training.sql`)
-   **RLS:** Define and apply RLS policies for gamification tables (`badges`, `user_badges`) allowing public read for definitions, user read for earned, and restricting modifications. (Migration: `20250413140000_add_rls_gamification.sql`)
-   **RLS:** Define and apply RLS policies for `custom_field_values` based on access to the parent entity (company, project, task, etc.), using a helper function `can_manage_entity_for_custom_field`. (Migration: `20250413150000_add_rls_custom_field_values.sql`)
-   **RLS:** Define and apply RLS policies for `audit_log` table, restricting SELECT to staff and disallowing direct modifications. (Migration: `20250413160000_add_rls_audit_logs.sql`)
-   **RLS:** Define and apply RLS policies for `notifications` (user/staff SELECT, staff DELETE) and `notification_settings` (user CRUD, staff SELECT). (Migration: `20250413170000_add_rls_notifications.sql`)
-   **FTS:** Implement Full-Text Search mechanism: Create `search_index` table, `update_search_index` trigger function, apply triggers to relevant tables, and add RLS policies to `search_index`. (Migration: `20250413180000_add_fts.sql`)
-   **DB Function:** Implement `clone_project` PostgreSQL function to duplicate projects, sections, tasks (preserving hierarchy), risks, issues, and custom fields. (Migration: `20250413190000_add_clone_project_function.sql`)
-   **Logging:** Implement logging to `background_job_failures` table within the `generate-recurring-tasks` Edge Function.
-   **Error Handling:** Refactor `companies` Edge Function to use standardized error response helpers (`createNotFoundResponse`, `createForbiddenResponse`, etc.) from `_shared/validation.ts`. Added new helper functions to `validation.ts`.
-   **Error Handling:** Refactor `projects` Edge Function to use standardized error response helpers (`createNotFoundResponse`, `createForbiddenResponse`, `createUnauthorizedResponse`, etc.) from `_shared/validation.ts`.
-   **Error Handling:** Refactor `milestones` Edge Function to use standardized error response helpers (`createNotFoundResponse`, `createForbiddenResponse`, `createUnauthorizedResponse`, `createConflictResponse`, etc.) from `_shared/validation.ts`.
-   **Error Handling:** Refactor `risks` Edge Function to use standardized error response helpers (`createNotFoundResponse`, `createForbiddenResponse`, `createUnauthorizedResponse`, etc.) from `_shared/validation.ts`.
-   **Error Handling:** Refactor `issues` Edge Function to use standardized error response helpers (`createNotFoundResponse`, `createForbiddenResponse`, `createUnauthorizedResponse`, `createConflictResponse`, `createBadRequestResponse`, etc.) from `_shared/validation.ts`.
-   **Error Handling:** Refactor `sections` Edge Function to use standardized error response helpers from `_shared/validation.ts`.
-   **Error Handling:** Refactor `tasks` Edge Function to use standardized error response helpers from `_shared/validation.ts`.
-   **Error Handling:** Refactor `task-comments` Edge Function to use standardized error response helpers from `_shared/validation.ts`.
-   **Error Handling:** Refactor `task-files` Edge Function to use standardized error response helpers from `_shared/validation.ts`.
-   **Error Handling:** Refactor `custom-field-definitions` Edge Function to use standardized error response helpers from `_shared/validation.ts`.
-   **Error Handling:** Refactor `instantiate-project-template` Edge Function to use standardized error response helpers from `_shared/validation.ts`.
-   **Error Handling:** Refactor `generate-recurring-tasks` Edge Function to use standardized error response helpers from `_shared/validation.ts`.
